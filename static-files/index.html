<!DOCTYPE html>
<meta charset="utf-8">
<title>Hello</title>
<script src="/socket.io/socket.io.js"></script>
<script src="/jquery.min.js"></script>
<script>
var PUNCTUATION = /[.?!]$/;
var PUNCTUATION_MAP = {
  '.': 'say',
  '!': 'exclaim',
  '?': 'ask'
};

function errorMessage(text) {
  // TODO: Make this non-modal.
  alert(text);
}

$(window).ready(function() {
  var socket = new io.Socket(window.location.hostname);
  var id = null;

  function addMessage(query) {
    $("#messages").append(query);
    var height = $(document.body).height();
    $(document.body).scrollTop(height);
  }
  
  function send(obj) {
    socket.send(JSON.stringify(obj));
  }

  function fillName(query, userID, forceThirdPerson) {
    var name;
    if (userID == id && !forceThirdPerson)
      name = $("#templates .you").clone();
    else {
      name = $("#templates .other").clone();
      name.find(".user-id").text(userID.toString());
    }
    query.find(".name").append(name);
  }

  var messageDelegate = {
    init: function(options) {
      id = options.id;
      var init = $("#templates .init").clone();
      fillName(init, id, true);
      addMessage(init);
      
      options.users.forEach(function(userID) {
        var present = $("#templates .present").clone();
        fillName(present, userID);
        addMessage(present);
      });
    },
    say: function(options) {
      var match = options.content.match(PUNCTUATION);
      var type = PUNCTUATION_MAP[match[0]];

      if (!type)
        throw new Error('unknown punctuation');

      var say = $("#templates > .say").clone();
      fillName(say, options.from);
      var verbSelector = ["#templates", ".verbs", "." + type];
      if (options.from == id)
        verbSelector.push(".plural");
      else
        verbSelector.push(".singular");
      var verb = $(verbSelector.join(' ')).clone();
      say.find(".verb").append(verb);
      say.find(".content").text(options.content);
      addMessage(say);
    },
    connect: function(options) {
      var connect = $("#templates .connect").clone();
      fillName(connect, options.id);
      addMessage(connect);
    },
    disconnect: function(options) {
      var disconnect = $("#templates .disconnect").clone();
      fillName(disconnect, options.id);
      addMessage(disconnect);
    }
  };

  //socket.on('connect', function() {});
  socket.on('message', function(data) {
    data = JSON.parse(data);
    if (data.msg in messageDelegate)
      messageDelegate[data.msg](data);
  });
  socket.on('disconnect', function() {
    id = null;
  });
  socket.connect();

  $("#prompt form").submit(function(event) {
    event.preventDefault();
    var input = $(this).find("input");
    var content = input.val();
    if (!content)
      return;
    if (!content.match(PUNCTUATION)) {
      errorMessage('Please use complete sentences.');
      return;
    }
    if (id === null) {
      errorMessage('You are disconnected.');
      return;
    }
    send({msg: 'say', content: content});
    input.val('');
  });
  
  $("#prompt input").focus();
});
</script>
<style>
body {
  font-family: Futura;
}

#templates {
  display: none;
}

#prompt input {
  border: none;
  outline: none;
  font-family: inherit;
  font-size: inherit;
}
</style>
<h1>Kitchen Party</h1>
<div id="messages">
</div>
<div id="prompt">
  <form>&gt; <input type="text"></form>
</div>
<div id="templates">
  <span class="you">you</span>
  <span class="other">number <span class="user-id"></span></span>
  <div class="init">
    You are now known as <span class="name"></span>.
  </div>
  <div class="present">
    <span class="name"></span> is here.
  </div>
  <div class="connect">
    <span class="name"></span> has joined the party.
  </div>
  <div class="disconnect">
    <span class="name"></span> has left the party.
  </div>
  <div class="say">
    <span class="name"></span>
    <span class="verb"></span>, “<span class="content"></span>”
  </div>
  <div class="verbs">
    <div class="say">
      <span class="singular">says</span>
      <span class="plural">say</span>
    </div>
    <div class="exclaim">
      <span class="singular">exclaims</span>
      <span class="plural">exclaim</span>
    </div>
    <div class="ask">
      <span class="singular">asks</span>
      <span class="plural">ask</span>
    </div>
  </div>
</div>
