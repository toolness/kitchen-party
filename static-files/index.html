<!DOCTYPE html>
<meta charset="utf-8">
<title>Hello</title>
<script src="/socket.io/socket.io.js"></script>
<script src="/jquery.min.js"></script>
<script>
function errorMessage(text) {
  // TODO: Make this non-modal.
  alert(text);
}

$(window).ready(function() {
  var socket = new io.Socket(window.location.hostname);
  var id = null;

  function send(obj) {
    socket.send(JSON.stringify(obj));
  }

  function fillName(query, id) {
    query.find(".name").text("number " + id);    
  }

  var messageDelegate = {
    init: function(options) {
      id = options.id;
      var init = $("#templates .init").clone();
      fillName(init, id);
      $("#messages").append(init);      
    },
    say: function(options) {
      var say = $("#templates .say").clone();
      fillName(say, options.from);
      say.find(".content").text(options.content);
      $("#messages").append(say);
    },
    connect: function(options) {
      var connect = $("#templates .connect").clone();
      fillName(connect, options.id);
      $("#messages").append(connect);
    },
    disconnect: function(options) {
      var disconnect = $("#templates .disconnect").clone();
      fillName(disconnect, options.id);
      $("#messages").append(disconnect);
    }
  };

  //socket.on('connect', function() {});
  socket.on('message', function(data) {
    data = JSON.parse(data);
    if (data.msg in messageDelegate)
      messageDelegate[data.msg](data);
  });
  socket.on('disconnect', function() {
    id = null;
  });
  socket.connect();

  $("#prompt input").keyup(function(event) {
    if (event.keyCode == 13) {
      if (id === null) {
        errorMessage('You are disconnected.');
        return;
      }
      send({msg: 'say', content: $(this).val()});
      $(this).val('');
    }
  }).focus();
});
</script>
<style>
body {
  font-family: Futura;
}

#templates {
  display: none;
}

#prompt input {
  border: none;
  outline: none;
  font-family: inherit;
  font-size: inherit;
}
</style>
<h1>Kitchen Party</h1>
<div id="messages">
</div>
<div id="prompt">
  &gt; <input type="text" id="user-input">
</div>
<div id="templates">
  <div class="init">
    You are now known as <span class="name"></span>.
  </div>
  <div class="connect">
    <span class="name"></span> has joined the party.
  </div>
  <div class="disconnect">
    <span class="name"></span> has left the party.
  </div>
  <div class="say">
    <span class="name"></span> says, “<span class="content"></span>”
  </div>
</div>
