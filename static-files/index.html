<!DOCTYPE html>
<meta charset="utf-8">
<title>Hello</title>
<script src="/socket.io/socket.io.js"></script>
<script src="/jquery.min.js"></script>
<script>
var PUNCTUATION = /[.?!]$/;
var PUNCTUATION_MAP = {
  '.': 'say',
  '!': 'exclaim',
  '?': 'ask'
};

function errorMessage(text) {
  // TODO: Make this non-modal.
  alert(text);
}

$(window).ready(function() {
  var socket = new io.Socket(window.location.hostname);
  var id = null;

  function send(obj) {
    socket.send(JSON.stringify(obj));
  }

  function fillName(query, id) {
    query.find(".name").text("number " + id);    
  }

  var messageDelegate = {
    init: function(options) {
      id = options.id;
      var init = $("#templates .init").clone();
      fillName(init, id);
      $("#messages").append(init);      
    },
    say: function(options) {
      var match = options.content.match(PUNCTUATION);
      var type = PUNCTUATION_MAP[match[0]];

      if (!type)
        throw new Error('unknown punctuation');

      var say = $("#templates ." + type).clone();
      fillName(say, options.from);
      say.find(".content").text(options.content);
      $("#messages").append(say);
    },
    connect: function(options) {
      var connect = $("#templates .connect").clone();
      fillName(connect, options.id);
      $("#messages").append(connect);
    },
    disconnect: function(options) {
      var disconnect = $("#templates .disconnect").clone();
      fillName(disconnect, options.id);
      $("#messages").append(disconnect);
    }
  };

  //socket.on('connect', function() {});
  socket.on('message', function(data) {
    data = JSON.parse(data);
    if (data.msg in messageDelegate)
      messageDelegate[data.msg](data);
  });
  socket.on('disconnect', function() {
    id = null;
  });
  socket.connect();

  $("#prompt form").submit(function(event) {
    event.preventDefault();
    var input = $(this).find("input");
    var content = input.val();
    if (!content)
      return;
    if (!content.match(PUNCTUATION)) {
      errorMessage('Please use complete sentences.');
      return;
    }
    if (id === null) {
      errorMessage('You are disconnected.');
      return;
    }
    send({msg: 'say', content: content});
    input.val('');
  });
  
  $("#prompt input").focus();
});
</script>
<style>
body {
  font-family: Futura;
}

#templates {
  display: none;
}

#prompt input {
  border: none;
  outline: none;
  font-family: inherit;
  font-size: inherit;
}
</style>
<h1>Kitchen Party</h1>
<div id="messages">
</div>
<div id="prompt">
  <form>&gt; <input type="text"></form>
</div>
<div id="templates">
  <div class="init">
    You are now known as <span class="name"></span>.
  </div>
  <div class="connect">
    <span class="name"></span> has joined the party.
  </div>
  <div class="disconnect">
    <span class="name"></span> has left the party.
  </div>
  <div class="say">
    <span class="name"></span> says, “<span class="content"></span>”
  </div>
  <div class="exclaim">
    <span class="name"></span> exclaims, “<span class="content"></span>”
  </div>
  <div class="ask">
    <span class="name"></span> asks, “<span class="content"></span>”
  </div>
</div>
